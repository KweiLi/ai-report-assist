{% extends "base.html" %}
{% block title %}Review - {{ job.filename }} - AI Report Assist{% endblock %}
{% block content %}
<section class="review-section">
    <h1>Report: {{ job.filename }}</h1>

    <div class="meta">
        <span class="badge">{{ job.pages }} page{{ 's' if job.pages != 1 }}</span>
        <span class="badge {% if job.is_scanned %}badge-warn{% endif %}">
            {{ 'Scanned (OCR)' if job.is_scanned else 'Native PDF' }}
        </span>
        <span class="badge badge-status">Status: {{ job.status }}</span>
    </div>

    {% if job.status == 'extracted' %}
    <div class="action-bar">
        <p>Text has been extracted. Click below to run the debiasing pipeline.</p>
        <form action="/process/{{ job_id }}" method="post">
            <button type="submit" class="btn btn-primary" id="processBtn"
                    onclick="this.disabled=true; this.textContent='Processing...'; this.form.submit();">
                Run Debiasing Pipeline
            </button>
        </form>
    </div>

    <h2>Extracted Text</h2>
    <div class="text-panel">
        <pre>{{ job.original_text }}</pre>
    </div>
    {% endif %}

    {% if job.status == 'processed' %}
    <div class="action-bar">
        <h2>Export</h2>
        <div class="export-form">
            <a href="/export/{{ job_id }}?format=pdf" class="btn btn-primary" download>Download PDF</a>
            <a href="/export/{{ job_id }}?format=docx" class="btn btn-primary" download>Download DOCX</a>
        </div>
    </div>

    {# ── Bias Legend (only types actually found) ── #}
    {% if job.bias_changes %}
    {% set found_types = job.bias_changes | map(attribute='bias_type') | list | unique | list %}
    <div class="bias-legend">
        <h3>Bias Types Found ({{ found_types | length }})</h3>
        <div class="legend-items">
            {% for bias_type in found_types %}
            {% set color = bias_colors.get(bias_type, '#999') %}
            <span class="legend-item" style="border-left: 4px solid {{ color }}; padding-left: 6px;">
                {{ bias_type | replace('_', ' ') | title }}
                <span class="legend-count">({{ job.bias_changes | selectattr('bias_type', 'equalto', bias_type) | list | length }})</span>
            </span>
            {% endfor %}
            <span class="legend-item" style="border-left: 4px solid #27ae60; padding-left: 6px;">
                Debiased (corrected)
            </span>
        </div>
        <p class="legend-hint">Hover over highlighted text for details</p>
    </div>
    {% endif %}

    {# ── Side-by-side Comparison ── #}
    <div class="comparison">
        <div class="panel">
            <h2>Original Text <span class="panel-subtitle">biased phrases highlighted</span></h2>
            <div class="text-panel highlighted-text">
                <pre>{{ job.original_highlighted | safe }}</pre>
            </div>
        </div>
        <div class="panel">
            <h2>Debiased Text <span class="panel-subtitle">corrections in green</span></h2>
            <div class="text-panel highlighted-text">
                <pre>{{ job.debiased_highlighted | safe }}</pre>
            </div>
        </div>
    </div>

    {# ── Bias Changes Detail ── #}
    {% if job.bias_changes %}
    <h2>Bias Analysis ({{ job.bias_changes | length }} issues found)</h2>
    <div class="bias-changes-panel">
        {% for c in job.bias_changes %}
        <div class="bias-change-item" style="border-left: 4px solid {{ bias_colors.get(c.bias_type, '#999') }};">
            <div class="bias-change-header">
                <span class="bias-type-tag" style="background: {{ bias_colors.get(c.bias_type, '#999') }};">
                    {{ c.bias_type | replace('_', ' ') }}
                </span>
            </div>
            <div class="bias-change-body">
                <div class="bias-original">
                    <strong>Original:</strong>
                    <span class="strike">"{{ c.original_phrase }}"</span>
                </div>
                <div class="bias-replacement">
                    <strong>Replacement:</strong>
                    <span class="green">"{{ c.replacement_phrase }}"</span>
                </div>
                <div class="bias-explanation">{{ c.explanation }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# ── Changes Summary ── #}
    {% if job.changes_summary %}
    <h2>Changes Summary</h2>
    <div class="summary-panel">
        <pre>{{ job.changes_summary }}</pre>
    </div>
    {% endif %}

    {# ── Masked Entities ── #}
    {% if job.entities_found %}
    <h2>Masked Entities ({{ job.entities_found | length }})</h2>
    <div class="entities-panel">
        <table>
            <thead>
                <tr><th>Type</th><th>Original</th><th>Token</th><th>Confidence</th></tr>
            </thead>
            <tbody>
                {% for e in job.entities_found %}
                <tr>
                    <td><code>{{ e.entity_type }}</code></td>
                    <td>{{ e.original }}</td>
                    <td><code>{{ e.token }}</code></td>
                    <td>{{ e.score }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {# ── Acronyms Preserved ── #}
    {% if job.acronyms_preserved %}
    <h2>Acronyms & Abbreviations Preserved ({{ job.acronyms_preserved | length }})</h2>
    <div class="entities-panel">
        <table>
            <thead>
                <tr><th>Acronym</th><th>Initially Detected As</th><th>Action</th></tr>
            </thead>
            <tbody>
                {% for a in job.acronyms_preserved %}
                <tr>
                    <td><strong>{{ a.text }}</strong></td>
                    <td><code>{{ a.detected_as }}</code></td>
                    <td>{{ a.reason }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% endif %}
</section>
{% endblock %}
